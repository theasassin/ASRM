#load dada2
library (dada2)

#set working directory
setwd("/home/sassin/CCRM_PCOS_Phase")

#set the correct path
path <- "home/sassin/CCRM_PCOS_Phase/CCRM"

#verify the correct path is set 
list.files(path)

# Forward and reverse fastq filenames have format: SAMPLENAME_R1_001.fastq (Aagaard.91.30435.Oral-read_R1_val_1.fq.gz) and SAMPLENAME_R2_001.fastq (Aagaard.91.30435.Oral-read_R2_val_2.fq.gz) 
fnFs <- sort(list.files(path, pattern="_R1_001.fq.gz", full.names = TRUE))
fnRs <- sort(list.files(path, pattern="_R2_001.fq.gz", full.names = TRUE))

# that didnt work, use this instead 
fnRs <- sort(list.files(path, pattern=".validated_R2.001.fq.gz", full.names=FALSE))
fnFs <- sort(list.files(path, pattern=".validated_R1.001.fq.gz", full.names=FALSE))

# Extract sample names, assuming filenames have format: SAMPLENAME_XXX.fastq
sample.names <- sapply(strsplit(basename(fnFs), "_"), `[`, 1)

#Run the Plot Quality of the reverse reads for four samples
plotQualityProfile(fnRs[1:4])

#Run the Plot Quality of the forward reads for four samples 
plotQualityProfile(fnFs[1:4])

# Place filtered files in filtered subdirectory
filtFs <- file.path(path, "filtered", paste0(sample.names, "_F_filt.fastq.gz"))
filtRs <- file.path(path, "filtered", paste0(sample.names, "_R_filt.fastq.gz"))
names(filtFs) <- sample.names
names(filtRs) <- sample.names

#Filter and Trim stage now. Will Filter forward reads at 240 and will filter reverse reads at 220
out <- filterAndTrim(fnFs, filtFs, fnRs, filtRs, truncLen=c(240,220),
                     maxN=0, maxEE=c(2,2), truncQ=2, rm.phix=TRUE,
                     compress=TRUE, multithread=FALSE)
                     
#Of note, received this error message 
# The filter removed all reads: monkeyid_trimmed_files//filtered/multimatched.validated_F_filt.fastq.gz and monkeyid_trimmed_files//filtered/multimatched.validated_R_filt.fastq.gz not written.
# Some input samples had no reads pass the filter.
# Warning messages:
# 1: In file.remove(fout[[1]]) :
  cannot remove file 'monkeyid_trimmed_files//filtered/multimatched.validated_F_filt.fastq.gz', reason 'No such file or directory'
# 2: In file.remove(fout[[2]]) :
  cannot remove file 'monkeyid_trimmed_files//filtered/multimatched.validated_R_filt.fastq.gz', reason 'No such file or directory'

#Run the Plot Quality of the forward TruncLen Filtered samples for four samples 
plotQualityProfile(filtFs [1:4])

#Run the Plot Quality of the reverse TruncLen Filtered samples for four samples 
plotQualityProfile(filtRs [1:4])

#Learn the Error Rates Forward 
errF <- learnErrors(filtFs, multithread=TRUE)

#Learn the Error Rates Reverse 
errR <- learnErrors(filtRs, multithread=TRUE)

#Check the estimated error rates in the forward reads 
plotErrors(errF, nominalQ=TRUE)

#check the estimated error rates in the reverse reads 
plotErrors(errR, nominalQ=TRUE)

#get a list of the files that still exist after filtering 
exists <- file.exists(filtFs)

#Dereplicate the existing files in forward
derepFs <- derepFastq(filtFs[exists], verbose=TRUE)

#Dereplicating the existing files in reverse
derepRs <- derepFastq(filtRs[exists], verbose=TRUE)

# Name the derep-class objects by the sample names
names(derepFs) <- sample.names[exists]
names(derepRs) <- sample.names[exists]

#Sample Inference of the derep forward samples pseudo pooling  
dadaFs <- dada(derepFs, err=errF, pool="pseudo", multithread=48)

#sample inference of the derep reverse samples pseudo pooling
dadaRs <- dada(derepRs, err=errR, pool="pseudo", multithread=48)

#inspecting the dada-class object
dadaFs[[1]]

#dada-class: object describing DADA2 denoising results
#243 sequence variants were inferred from 3181 input unique sequences.
#Key parameters: OMEGA_A = 1e-40, OMEGA_C = 1e-40, BAND_SIZE = 16

#Merge paired reads 
mergers <- mergePairs(dadaFs, derepFs, dadaRs, derepRs, verbose=TRUE)

# Inspect the merger data.frame from the first sample
head(mergers[[1]])# Inspect the merger data.frame from the first sample
head(mergers[[1]])

#construct an ASV sequence table 
seqtab <- makeSequenceTable(mergers)
dim(seqtab)

# Inspect distribution of sequence lengths
table(nchar(getSequences(seqtab)))
# results below 
#240  248  249  251  252  253  254  255  313  314  335  336  388  413  416  417 
  #4    1    3    8 1930 7339  202    4    2    1    2    1    3    1    2    1 
# can remove non target length sequences with seqtab2 <- seqtab[,nchar(colnames(seqtab)) %in% 250:256]).

# Remove chimeras
seqtab.nochim <- removeBimeraDenovo(seqtab, method="consensus", multithread=TRUE, verbose=TRUE)
dim(seqtab.nochim)

# Determine the frequency of chimeras 
sum(seqtab.nochim)/sum(seqtab)
# 0.8940161, so they count for about about 11% of merged sequence reads 

# Track reads through the pipeline and make sure they made it thru the pipeline
getN <- function(x) sum(getUniques(x))
track <- cbind(out, sapply(dadaFs, getN), sapply(dadaRs, getN), sapply(mergers, getN), rowSums(seqtab.nochim))

#Warning message:
#In cbind(out, sapply(dadaFs, getN), sapply(dadaRs, getN), sapply(mergers,  :
#number of rows of result is not a multiple of vector length (arg 2)

# If processing a single sample, remove the sapply calls: e.g. replace sapply(dadaFs, getN) with getN(dadaFs)
colnames(track) <- c("input", "filtered", "denoisedF", "denoisedR", "merged", "nonchim")
rownames(track) <- sample.names

#take a look at the data 
head(track)

#make a table in TSV form
write.table(track, "Renamed-cohortsonly-data-read-count-tracking.tsv", quote=FALSE, sep="\t", col.names=NA)

#### continuing via the DADA2 Tutorial pipeline ---> skip to astrobiomike portion if you want to use decipher  
taxa <- assignTaxonomy(seqtab.nochim, "silva_nr99_v138.1_train_set.fa.gz", multithread=TRUE)

#error message 
# Warning messages:
#1: In UseMethod("depth") :
 # no applicable method for 'depth' applied to an object of class "NULL"
#2: In UseMethod("depth") :
 # no applicable method for 'depth' applied to an object of class "NULL"
#3: In UseMethod("depth") :
 # no applicable method for 'depth' applied to an object of class "NULL"

#Inspecting the taxonomic assignments 
taxa.print <- taxa # Removing sequence rownames for display only
rownames(taxa.print) <- NULL
head(taxa.print)

library(phyloseq)

library(Biostrings)

library(ggplot2)

theme_set(theme_bw())

#continuing along DADA 2 pipeline tutorial, now we construct a simple data.frame and run phyloseq 

samples.out <- rownames(seqtab.nochim)

#Names of subjects 
subject.numbers <- sapply(strsplit(samples.out, "[.]"), `[`, 2)

#Names of monkeys
monkey.numbers <- sapply(strsplit(samples.out, "[.]"), `[`, 3)

#Names of Cohorts
cohort.numbers <- sapply(strsplit(samples.out, "[.]"), `[`, 4)

#Names of diet treatment 
diet.treatment <- sapply(strsplit(samples.out,"[.]"), `[`, 5)

#Names of hormone treatment 
hormone.treatment <- sapply(strsplit(samples.out,"[.]"), `[`, 6)

#Names of body sites 
body.site <- sapply(strsplit(samples.out,"[.]"), `[`, 7)

#Names of cycle phase 
cycle.phase <- sapply(strsplit(samples.out,"[.]"), `[`, 8)

#Make our data frame 
samdf <- data.frame(Subject=subject.numbers, MonkeyID=monkey.numbers, Cohort=cohort.numbers, Diet=diet.treatment, Hormone=hormone.treatment, Site=body.site, Phase=cycle.phase)
rownames(samdf) <- samples.out

#Construct our Phyloseq object 
ps <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE), 
               sample_data(samdf), 
               tax_table(taxa))

# Store DNA sequences of our ASVs in the refseq spot 
dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))
ps

#Visualize alpha diversity 
plot_richness(ps, x="Site", measures=c("Shannon", "Simpson"), color="Cohort")


# Transform data to proportions as appropriate for Bray-Curtis distances
ps.prop <- transform_sample_counts(ps, function(otu) otu/sum(otu))
ord.nmds.bray <- ordinate(ps.prop, method="NMDS", distance="bray")

plot_ordination(ps.prop, ord.nmds.bray, color="Site", title="Bray NMDS")
plot_ordination(ps.prop, ord.nmds.bray, color="Cohort", title="Bray NMDS")

#Now to make a Bar Plot of top 20 
top20 <- names(sort(taxa_sums(ps), decreasing=TRUE))[1:20]
ps.top20 <- transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)
plot_bar(ps.top20, x="Cohort", fill="Family") + facet_wrap(~Site, scales="free_x")

#Bar Plot of top 10 
top10 <- names(sort(taxa_sums(ps), decreasing=TRUE))[1:10]
ps.top10 <- transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
ps.top10 <- prune_taxa(top10, ps.top10)
plot_bar(ps.top10, x="Cohort", fill="Family") + facet_wrap(~Site, scales="free_x")


#to make a very busy relative abundance chart 
plot_bar(ps.top20, fill="Phylum") + geom_bar(aes(color = Phylum, fill = Phylum), stat="identity", position="stack") + labs(x = "Cohort", y = "Relative Abundance\n") + theme(panel.background = element_blank())


#### here starts the astrobiomike way of processing the data via DECIPHER 

## downloading DECIPHER-formatted SILVA v138 reference
download.file(url="http://www2.decipher.codes/Classification/TrainingSets/SILVA_SSU_r138_2019.RData", destfile="SILVA_SSU_r138.RData")

## loading reference taxonomy object
load(SILVA_SSU_r138_2019.RData)

## loading DECIPHER
library(DECIPHER)

library(dada2)

## creating DNAStringSet object of our ASVs
dna <- DNAStringSet(getSequences(seqtab.nochim))

#and classifying
tax_info <- IdTaxa(test=dna, trainingSet=trainingSet, strand="both", processors=NULL) 

# giving our seq headers more manageable names (ASV_1, ASV_2...)
asv_seqs <- colnames(seqtab.nochim)
asv_headers <- vector(dim(seqtab.nochim)[2], mode="character")

for (i in 1:dim(seqtab.nochim)[2]) {
  asv_headers[i] <- paste(">ASV", i, sep="_")
}

# making and writing out a fasta of our final ASV seqs:
asv_fasta <- c(rbind(asv_headers, asv_seqs))
write(asv_fasta, "ASVs.fa")

# count table:
asv_tab <- t(seqtab.nochim)
row.names(asv_tab) <- sub(">", "", asv_headers)
write.table(asv_tab, "ASVs_counts.tsv", sep="\t", quote=F, col.names=NA)

# tax table:
# creating table of taxonomy and setting any that are unclassified as "NA"
ranks <- c("domain", "phylum", "class", "order", "family", "genus", "species")
asv_tax <- t(sapply(tax_info, function(x) {
  m <- match(ranks, x$rank)
  taxa <- x$taxon[m]
  taxa[startsWith(taxa, "unclassified_")] <- NA
  taxa
}))
colnames(asv_tax) <- ranks
rownames(asv_tax) <- gsub(pattern=">", replacement="", x=asv_headers)

write.table(asv_tax, "ASVs_taxonomy.tsv", sep = "\t", quote=F, col.names=NA)

#Decontam 
> vector_for_decontam <- c(rep(FALSE, 392), rep(TRUE, 8), rep(FALSE, 104))
> contam_df <- isContaminant(t(asv_tab), neg=vector_for_decontam)
> table(contam_df$contaminant)

#FALSE  TRUE 
#4717   121 

contam_asvs <- row.names(contam_df[contam_df$contaminant == TRUE, ])
contam_asvs <- row.names(contam_df[contam_df$contaminant == TRUE, ])
asv_tax[row.names(asv_tax) %in% contam_asvs, ]

# Here are the results 
         domain      phylum             class                 order                                
ASV_1    NA          NA                 NA                    NA                                   
ASV_2    "Bacteria"  "Fusobacteriota"   "Fusobacteriia"       "Fusobacteriales"                    
ASV_6    "Bacteria"  "Actinobacteriota" "Actinobacteria"      "Bifidobacteriales"                  
ASV_8    "Bacteria"  "Firmicutes"       "Clostridia"          "Lachnospirales"                     
ASV_10   "Bacteria"  "Bacteroidota"     "Bacteroidia"         "Bacteroidales"                      
ASV_12   "Bacteria"  "Firmicutes"       "Clostridia"          NA                                   
ASV_14   NA          NA                 NA                    NA                                   
ASV_16   "Bacteria"  "Firmicutes"       "Clostridia"          NA                                   
ASV_17   "Bacteria"  "Campilobacterota" "Campylobacteria"     "Campylobacterales"                  
ASV_21   "Bacteria"  "Firmicutes"       "Negativicutes"       "Veillonellales-Selenomonadales"     
ASV_23   NA          NA                 NA                    NA                                   
ASV_25   "Bacteria"  "Actinobacteriota" "Actinobacteria"      "Bifidobacteriales"                  
ASV_27   "Bacteria"  "Fusobacteriota"   "Fusobacteriia"       "Fusobacteriales"                    
ASV_28   NA          NA                 NA                    NA                                   
ASV_34   "Bacteria"  "Campilobacterota" "Campylobacteria"     "Campylobacterales"                  
ASV_37   "Bacteria"  "Actinobacteriota" "Coriobacteriia"      "Coriobacteriales"                   
ASV_40   "Bacteria"  "Actinobacteriota" "Actinobacteria"      "Actinomycetales"                    
ASV_48   "Bacteria"  NA                 NA                    NA                                   
ASV_59   "Bacteria"  "Actinobacteriota" "Actinobacteria"      "Actinomycetales"                    
ASV_74   "Bacteria"  "Firmicutes"       "Negativicutes"       "Veillonellales-Selenomonadales"     
ASV_96   "Bacteria"  "Firmicutes"       "Negativicutes"       "Veillonellales-Selenomonadales"     
ASV_102  "Bacteria"  "Firmicutes"       "Bacilli"             "Mycoplasmatales"                    
ASV_112  "Bacteria"  "Firmicutes"       "Clostridia"          "Peptostreptococcales-Tissierellales"
ASV_122  NA          NA                 NA                    NA                                   
ASV_127  "Bacteria"  "Firmicutes"       "Bacilli"             "Lactobacillales"                    
ASV_129  "Bacteria"  "Firmicutes"       "Clostridia"          "Peptostreptococcales-Tissierellales"
ASV_140  NA          NA                 NA                    NA                                   
ASV_150  "Bacteria"  "Firmicutes"       "Clostridia"          "Peptostreptococcales-Tissierellales"
ASV_151  "Bacteria"  "Firmicutes"       "Clostridia"          "Lachnospirales"                     
ASV_154  "Bacteria"  "Firmicutes"       NA                    NA                                   
ASV_182  "Bacteria"  "Actinobacteriota" "Actinobacteria"      "Corynebacteriales"                  
ASV_186  "Bacteria"  "Firmicutes"       "Clostridia"          "Peptostreptococcales-Tissierellales"
ASV_187  NA          NA                 NA                    NA                                   
ASV_189  "Bacteria"  "Firmicutes"       "Clostridia"          "Peptostreptococcales-Tissierellales"
ASV_192  "Bacteria"  "Campilobacterota" "Campylobacteria"     "Campylobacterales"                  
ASV_194  NA          NA                 NA                    NA                                   
ASV_218  "Bacteria"  "Firmicutes"       "Clostridia"          "Peptostreptococcales-Tissierellales"
ASV_250  NA          NA                 NA                    NA                                   
ASV_310  "Bacteria"  "Bacteroidota"     "Bacteroidia"         "Bacteroidales"                      
ASV_340  "Bacteria"  "Actinobacteriota" "Actinobacteria"      "Bifidobacteriales"                  
ASV_364  "Bacteria"  NA                 NA                    NA                                   
ASV_405  "Bacteria"  "Firmicutes"       NA                    NA                                   
ASV_426  "Bacteria"  "Firmicutes"       "Clostridia"          "Peptostreptococcales-Tissierellales"
ASV_450  "Bacteria"  "Firmicutes"       "Bacilli"             "Staphylococcales"                   
ASV_489  "Archaea"   "Thermoplasmatota" "Thermoplasmata"      "Methanomassiliicoccales"            
ASV_535  "Bacteria"  "Firmicutes"       "Clostridia"          "Oscillospirales"                    
ASV_538  "Bacteria"  "Firmicutes"       "Clostridia"          "Lachnospirales"                     
ASV_575  NA          NA                 NA                    NA                                   
ASV_589  "Bacteria"  "Firmicutes"       "Clostridia"          "Oscillospirales"                    
ASV_610  NA          NA                 NA                    NA                                   
ASV_674  "Bacteria"  "Firmicutes"       "Bacilli"             "Lactobacillales"                    
ASV_676  "Bacteria"  "Cyanobacteria"    "Vampirivibrionia"    "Gastranaerophilales"                
ASV_770  "Bacteria"  "Bacteroidota"     "Bacteroidia"         "Bacteroidales"                      
ASV_776  "Bacteria"  NA                 NA                    NA                                   
ASV_804  "Bacteria"  "Fibrobacterota"   "Fibrobacteria"       "Fibrobacterales"                    
ASV_818  "Bacteria"  NA                 NA                    NA                                   
ASV_827  "Bacteria"  "Cyanobacteria"    "Vampirivibrionia"    "Gastranaerophilales"                
ASV_856  "Bacteria"  "Firmicutes"       "Clostridia"          "Lachnospirales"                     
ASV_891  "Bacteria"  "Bacteroidota"     "Bacteroidia"         "Bacteroidales"                      
ASV_895  "Bacteria"  "Firmicutes"       "Bacilli"             "Bacillales"                         
ASV_991  "Bacteria"  "Firmicutes"       "Clostridia"          "Oscillospirales"                    
ASV_992  "Bacteria"  "Firmicutes"       "Clostridia"          "Clostridia UCG-014"                 
ASV_1152 "Bacteria"  "Firmicutes"       "Bacilli"             "Acholeplasmatales"                  
ASV_1203 "Bacteria"  "Firmicutes"       "Clostridia"          "Oscillospirales"                    
ASV_1221 "Bacteria"  "Firmicutes"       "Clostridia"          "Clostridia UCG-014"                 
ASV_1237 "Bacteria"  "Firmicutes"       "Clostridia"          "Lachnospirales"                     
ASV_1262 "Bacteria"  "Firmicutes"       "Bacilli"             "Lactobacillales"                    
ASV_1269 NA          NA                 NA                    NA                                   
ASV_1389 "Bacteria"  "Firmicutes"       "Clostridia"          "Clostridia UCG-014"                 
ASV_1396 NA          NA                 NA                    NA                                   
ASV_1398 "Bacteria"  "Firmicutes"       "Clostridia"          "Lachnospirales"                     
ASV_1490 NA          NA                 NA                    NA                                   
ASV_1499 "Bacteria"  "Firmicutes"       "Bacilli"             "RF39"                               
ASV_1508 NA          NA                 NA                    NA                                   
ASV_1514 "Bacteria"  "Actinobacteriota" "Actinobacteria"      "Bifidobacteriales"                  
ASV_1521 "Bacteria"  "Firmicutes"       "Clostridia"          "Oscillospirales"                    
ASV_1524 "Bacteria"  "Firmicutes"       "Clostridia"          NA                                   
ASV_1539 "Bacteria"  "Firmicutes"       "Bacilli"             "Erysipelotrichales"                 
ASV_1567 "Bacteria"  "Firmicutes"       "Clostridia"          "Oscillospirales"                    
ASV_1576 "Bacteria"  "Firmicutes"       "Bacilli"             "Lactobacillales"                    
ASV_1634 "Bacteria"  "Firmicutes"       "Bacilli"             "Erysipelotrichales"                 
ASV_1637 "Bacteria"  NA                 NA                    NA                                   
ASV_1651 NA          NA                 NA                    NA                                   
ASV_1654 NA          NA                 NA                    NA                                   
ASV_1664 "Bacteria"  "Firmicutes"       "Clostridia"          "Oscillospirales"                    
ASV_1668 "Bacteria"  "Cyanobacteria"    "Cyanobacteriia"      "Chloroplast"                        
ASV_1682 "Bacteria"  "Actinobacteriota" "Actinobacteria"      "Corynebacteriales"                  
ASV_1708 "Bacteria"  NA                 NA                    NA                                   
ASV_1716 "Bacteria"  NA                 NA                    NA                                   
ASV_1795 NA          NA                 NA                    NA                                   
ASV_1830 "Bacteria"  "Firmicutes"       "Clostridia"          "Peptostreptococcales-Tissierellales"
ASV_1835 NA          NA                 NA                    NA                                   
ASV_1846 NA          NA                 NA                    NA                                   
ASV_1854 "Bacteria"  "Firmicutes"       "Clostridia"          "Lachnospirales"                     
ASV_1861 "Bacteria"  "Cyanobacteria"    "Vampirivibrionia"    "Gastranaerophilales"                
ASV_1865 "Bacteria"  "Proteobacteria"   "Gammaproteobacteria" "Pseudomonadales"                    
ASV_1871 "Bacteria"  "Firmicutes"       "Clostridia"          "Clostridia UCG-014"                 
ASV_1886 "Bacteria"  "Firmicutes"       "Bacilli"             "RF39"                               
ASV_1974 NA          NA                 NA                    NA                                   
ASV_1985 "Bacteria"  "Firmicutes"       "Clostridia"          NA                                   
ASV_2023 NA          NA                 NA                    NA                                   
ASV_2057 NA          NA                 NA                    NA                                   
ASV_2086 "Bacteria"  "Firmicutes"       "Clostridia"          NA                                   
ASV_2102 "Bacteria"  "Firmicutes"       "Clostridia"          "Lachnospirales"                     
ASV_2139 "Bacteria"  "Proteobacteria"   "Gammaproteobacteria" "Burkholderiales"                    
ASV_2143 "Bacteria"  "Bacteroidota"     "Bacteroidia"         "Bacteroidales"                      
ASV_2150 "Bacteria"  "Cyanobacteria"    "Cyanobacteriia"      "Chloroplast"                        
ASV_2223 "Bacteria"  "Firmicutes"       "Bacilli"             "Erysipelotrichales"                 
ASV_2233 "Bacteria"  "Cyanobacteria"    "Cyanobacteriia"      "Chloroplast"                        
ASV_2234 "Bacteria"  "Proteobacteria"   "Gammaproteobacteria" "Burkholderiales"                    
ASV_2240 "Bacteria"  "Firmicutes"       "Bacilli"             "RF39"                               
ASV_2267 "Bacteria"  "Firmicutes"       "Clostridia"          "Oscillospirales"                    
ASV_2274 "Bacteria"  NA                 NA                    NA                                   
ASV_2275 "Bacteria"  "Firmicutes"       NA                    NA                                   
ASV_2278 "Bacteria"  "Firmicutes"       "Clostridia"          "Monoglobales"                       
ASV_2282 NA          NA                 NA                    NA                                   
ASV_2329 "Bacteria"  "Firmicutes"       "Bacilli"             "RF39"                               
ASV_2334 "Bacteria"  "Firmicutes"       "Bacilli"             "RF39"                               
ASV_2508 "Eukaryota" NA                 NA                    NA                                   
ASV_2640 "Bacteria"  "Firmicutes"       "Bacilli"             "RF39"                               
ASV_2718 "Bacteria"  "Proteobacteria"   "Alphaproteobacteria" "Rickettsiales"                      
         family                                  genus                         species
ASV_1    NA                                      NA                            NA     
ASV_2    "Leptotrichiaceae"                      NA                            NA     
ASV_6    "Bifidobacteriaceae"                    "Gardnerella"                 NA     
ASV_8    "Lachnospiraceae"                       NA                            NA     
ASV_10   "Porphyromonadaceae"                    "Porphyromonas"               NA     
ASV_12   NA                                      NA                            NA     
ASV_14   NA                                      NA                            NA     
ASV_16   "Hungateiclostridiaceae"                "Fastidiosipila"              NA     
ASV_17   "Campylobacteraceae"                    "Campylobacter"               NA     
ASV_21   "Veillonellaceae"                       "Dialister"                   NA     
ASV_23   NA                                      NA                            NA     
ASV_25   "Bifidobacteriaceae"                    "Gardnerella"                 NA     
ASV_27   "Fusobacteriaceae"                      "Fusobacterium"               NA     
ASV_28   NA                                      NA                            NA     
ASV_34   "Campylobacteraceae"                    "Campylobacter"               NA     
ASV_37   "Atopobiaceae"                          "Atopobium"                   NA     
ASV_40   "Actinomycetaceae"                      "Mobiluncus"                  NA     
ASV_48   NA                                      NA                            NA     
ASV_59   "Actinomycetaceae"                      "Mobiluncus"                  NA     
ASV_74   "Veillonellaceae"                       "Dialister"                   NA     
ASV_96   "Veillonellaceae"                       "Megasphaera"                 NA     
ASV_102  "Mycoplasmataceae"                      "Mycoplasma"                  NA     
ASV_112  NA                                      "Anaerococcus"                NA     
ASV_122  NA                                      NA                            NA     
ASV_127  "Carnobacteriaceae"                     NA                            NA     
ASV_129  NA                                      NA                            NA     
ASV_140  NA                                      NA                            NA     
ASV_150  NA                                      "Parvimonas"                  NA     
ASV_151  "Lachnospiraceae"                       NA                            NA     
ASV_154  NA                                      NA                            NA     
ASV_182  "Corynebacteriaceae"                    "Corynebacterium"             NA     
ASV_186  NA                                      "Peptoniphilus"               NA     
ASV_187  NA                                      NA                            NA     
ASV_189  NA                                      "Anaerococcus"                NA     
ASV_192  "Campylobacteraceae"                    "Campylobacter"               NA     
ASV_194  NA                                      NA                            NA     
ASV_218  NA                                      "Peptoniphilus"               NA     
ASV_250  NA                                      NA                            NA     
ASV_310  "Porphyromonadaceae"                    "Porphyromonas"               NA     
ASV_340  "Bifidobacteriaceae"                    "Gardnerella"                 NA     
ASV_364  NA                                      NA                            NA     
ASV_405  NA                                      NA                            NA     
ASV_426  NA                                      "Ezakiella"                   NA     
ASV_450  "Staphylococcaceae"                     "Staphylococcus"              NA     
ASV_489  "Methanomethylophilaceae"               NA                            NA     
ASV_535  "Ruminococcaceae"                       "Ruminococcus"                NA     
ASV_538  "Lachnospiraceae"                       NA                            NA     
ASV_575  NA                                      NA                            NA     
ASV_589  "Oscillospiraceae"                      "UCG-005"                     NA     
ASV_610  NA                                      NA                            NA     
ASV_674  "Aerococcaceae"                         "Aerococcus"                  NA     
ASV_676  NA                                      NA                            NA     
ASV_770  "Bacteroidales RF16 group"              NA                            NA     
ASV_776  NA                                      NA                            NA     
ASV_804  "Fibrobacteraceae"                      "Fibrobacter"                 NA     
ASV_818  NA                                      NA                            NA     
ASV_827  NA                                      NA                            NA     
ASV_856  "Lachnospiraceae"                       NA                            NA     
ASV_891  "Bacteroidales RF16 group"              NA                            NA     
ASV_895  "Bacillaceae"                           NA                            NA     
ASV_991  "Ruminococcaceae"                       "[Eubacterium] siraeum group" NA     
ASV_992  NA                                      NA                            NA     
ASV_1152 "Acholeplasmataceae"                    "Anaeroplasma"                NA     
ASV_1203 NA                                      NA                            NA     
ASV_1221 NA                                      NA                            NA     
ASV_1237 "Lachnospiraceae"                       NA                            NA     
ASV_1262 "Aerococcaceae"                         "Facklamia"                   NA     
ASV_1269 NA                                      NA                            NA     
ASV_1389 NA                                      NA                            NA     
ASV_1396 NA                                      NA                            NA     
ASV_1398 "Lachnospiraceae"                       "Lachnospiraceae UCG-003"     NA     
ASV_1490 NA                                      NA                            NA     
ASV_1499 NA                                      NA                            NA     
ASV_1508 NA                                      NA                            NA     
ASV_1514 "Bifidobacteriaceae"                    "Bifidobacterium"             NA     
ASV_1521 "Ruminococcaceae"                       NA                            NA     
ASV_1524 NA                                      NA                            NA     
ASV_1539 "Erysipelatoclostridiaceae"             "UCG-004"                     NA     
ASV_1567 "Ruminococcaceae"                       "Ruminococcus"                NA     
ASV_1576 "Lactobacillaceae"                      "Lactobacillus"               NA     
ASV_1634 "Erysipelatoclostridiaceae"             "UCG-004"                     NA     
ASV_1637 NA                                      NA                            NA     
ASV_1651 NA                                      NA                            NA     
ASV_1654 NA                                      NA                            NA     
ASV_1664 NA                                      NA                            NA     
ASV_1668 NA                                      NA                            NA     
ASV_1682 "Corynebacteriaceae"                    NA                            NA     
ASV_1708 NA                                      NA                            NA     
ASV_1716 NA                                      NA                            NA     
ASV_1795 NA                                      NA                            NA     
ASV_1830 "Anaerovoracaceae"                      "Family XIII AD3011 group"    NA     
ASV_1835 NA                                      NA                            NA     
ASV_1846 NA                                      NA                            NA     
ASV_1854 "Lachnospiraceae"                       "Anaerosporobacter"           NA     
ASV_1861 NA                                      NA                            NA     
ASV_1865 "Moraxellaceae"                         "Psychrobacter"               NA     
ASV_1871 NA                                      NA                            NA     
ASV_1886 NA                                      NA                            NA     
ASV_1974 NA                                      NA                            NA     
ASV_1985 NA                                      NA                            NA     
ASV_2023 NA                                      NA                            NA     
ASV_2057 NA                                      NA                            NA     
ASV_2086 NA                                      NA                            NA     
ASV_2102 "Lachnospiraceae"                       NA                            NA     
ASV_2139 "Comamonadaceae"                        NA                            NA     
ASV_2143 "Rikenellaceae"                         "Rikenellaceae RC9 gut group" NA     
ASV_2150 NA                                      NA                            NA     
ASV_2223 "Erysipelatoclostridiaceae"             "UCG-004"                     NA     
ASV_2233 NA                                      NA                            NA     
ASV_2234 "Oxalobacteraceae"                      "Massilia"                    NA     
ASV_2240 NA                                      NA                            NA     
ASV_2267 "[Eubacterium] coprostanoligenes group" NA                            NA     
ASV_2274 NA                                      NA                            NA     
ASV_2275 NA                                      NA                            NA     
ASV_2278 "Monoglobaceae"                         "Monoglobus"                  NA     
ASV_2282 NA                                      NA                            NA     
ASV_2329 NA                                      NA                            NA     
ASV_2334 NA                                      NA                            NA     
ASV_2508 NA                                      NA                            NA     
ASV_2640 NA                                      NA                            NA     
ASV_2718 "Mitochondria"                          NA                            NA    

contam_indices <- which(asv_fasta %in% paste0(">", contam_asvs))
dont_want <- sort(c(contam_indices, contam_indices + 1))
asv_fasta_no_contam <- asv_fasta[- dont_want]
asv_tab_no_contam <- asv_tab[!row.names(asv_tab) %in% contam_asvs, ]
asv_tax_no_contam <- asv_tax[!row.names(asv_tax) %in% contam_asvs, ]
write(asv_fasta_no_contam, "ASVs-no-contam.fa")
write.table(asv_tab_no_contam, "ASVs_counts-no-contam.tsv",
+             sep="\t", quote=F, col.names=NA)
write.table(asv_tax_no_contam, "ASVs_taxonomy-no-contam.tsv",
+             sep="\t", quote=F, col.names=NA)

#make count tab and tax tables 
count_tab <- read.table("ASVs_counts.tsv", header=T, row.names=1,
                         check.names=F, sep="\t")
tax_tab <- as.matrix(read.table("ASVs_taxonomy.tsv", header=T,
                                row.names=1, check.names=F, sep="\t"))

# Create a sample info tab using a TSV file of the samples and variables 
sample_info_tab <- read.table("ccrm504.tsv", header=T, row.names=1,
check.names=F, sep="\t")

#add color to cohort 
sample_info_tab$Cohort <- as.character(sample_info_tab$Cohort)

deseq_counts <- DESeqDataSetFromMatrix(count_tab, colData = sample_info_tab, design = ~Phase)

deseq_counts_vst <- varianceStabilizingTransformation(deseq_counts)
# NOTE: If you get this error here with your dataset: "Error in
# estimateSizeFactorsForMatrix(counts(object), locfunc =locfunc, : every
# gene contains at least one zero, cannot compute log geometric means", that
# can be because the count table is sparse with many zeroes, which is common
# with marker-gene surveys. In that case you'd need to use a specific
# function first that is equipped to deal with that. 

# Given error message, ran the following as suggested 
deseq_counts <- estimateSizeFactors(deseq_counts, type = "poscounts")
# now followed by the transformation function:
deseq_counts_vst <- varianceStabilizingTransformation(deseq_counts)

# to make hierarchy cluster 
euc_clust <- hclust(euc_dist, method="ward.D2")
plot(euc_clust) 
euc_dend <- as.dendrogram(euc_clust, hang=0.1)
dend_cols <- as.character(sample_info_tab$color[order.dendrogram(euc_dend)])
labels_colors(euc_dend) <- dend_cols
plot(euc_dend, ylab="VST Euc. dist.")

# To make phyloseq object with transformed table 
vst_count_phy <- otu_table(vst_trans_count_tab, taxa_are_rows=T)
sample_info_tab_phy <- sample_data(sample_info_tab)
vst_physeq <- phyloseq(vst_count_phy, sample_info_tab_phy)
